<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Gender Detection</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        #content {
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="content">
        <h1>Voice Gender Detection</h1>
        <form id="voiceForm" enctype="multipart/form-data">
            <label for="inputType">Select input type:</label>
            <select id="inputType" name="inputType" onchange="handleInputTypeChange()">
                <option value="file">File</option>
                <option value="live">Live</option>
            </select>
            <div id="audioPlayer" style="display: none;">
                <audio controls id="audioPlayback">
                    Your browser does not support the audio element.
                </audio>
                <button type="button" id="replayButton" onclick="replayAudio()" style="display: none;">Replay Audio</button>
            </div>

            <div id="fileSection">
                <label for="audio_data">Select an audio file:</label>
                <input type="file" id="audio_data" name="audio_data" accept=".wav">
            </div>
            <div id="liveSection" style="display: none;">
                <label for="live">Live Recording:</label>
                <button type="button" id="startLive" onclick="startRecording()">Start Live Recording</button>
                <button type="button" id="stopLive" style="display: none;" onclick="stopRecording()">Stop Live Recording</button>
            </div>
            <br>
            <button type="button" onclick="processVoice()">Process</button>
        </form>
        <div id="result"></div>
    </div>  
    <script>
        var audioContext;
        var mediaRecorder;
        var chunks;
        var stream;

        function handleInputTypeChange() {
            var inputType = document.getElementById('inputType').value;
            document.getElementById('fileSection').style.display = inputType === 'file' ? 'block' : 'none';
            document.getElementById('liveSection').style.display = inputType === 'live' ? 'block' : 'none';
        }

       

        function startRecording() {
    chunks = [];
    if (!stream) {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function (_stream) {
                stream = _stream;
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = function (e) {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = function () {
                    var blob = new Blob(chunks, { type: 'audio/wav' });

                    // Create a File object with the recorded audio data
                    var audioFile = new File([blob], 'recorded_audio.wav', { type: 'audio/wav' });
                    
                    // Append the File object to the FormData
                    var form_data = new FormData();
                    form_data.append('audio_data', audioFile);

                    // Submit the FormData
                    fetch('/process', {
                        method: 'POST',
                        body: form_data
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('result').innerHTML = "Predicted Gender: " + data.gender;
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                };

                mediaRecorder.start();
                document.getElementById('startLive').style.display = 'none';
                document.getElementById('stopLive').style.display = 'inline-block';
            })
            .catch(function (err) {
                console.error('Error accessing microphone:', err);
            });
    } else {
        // If stream is already present, just start recording
        mediaRecorder.start();
        document.getElementById('startLive').style.display = 'none';
        document.getElementById('stopLive').style.display = 'inline-block';
    }
}

function stopRecording() {
    mediaRecorder.stop();

    if (stream) {
        let tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
    }

    if (audioContext) {
        audioContext.close();
    }

    // Reset the variables
    stream = null;
    audioContext = null;
    mediaRecorder = null;
    chunks = [];

    // Disable the audio player and replay button
    document.getElementById('audioPlayer').style.display = 'none';
    document.getElementById('replayButton').style.display = 'none';

    // Enable the start button and disable the stop button
    document.getElementById('startLive').style.display = 'inline-block';
    document.getElementById('stopLive').style.display = 'none';
}





function processVoice() {
    var form_data = new FormData();
    var inputType = document.getElementById('inputType').value;

    if (inputType === 'file') {
        var audioFileInput = document.getElementById('audio_data');
        var audioFile = audioFileInput.files[0];
        form_data.append('audio_data', audioFile);
    }

    fetch('/process', {
        method: 'POST',
        body: form_data,
        headers: {
            'Accept': 'application/json', // Make sure the server can accept JSON
        },
    })
        .then(response => response.json())
        .then(data => {
            document.getElementById('result').innerHTML = "Predicted Gender: " + data.gender;
        })
        .catch(error => {
            console.error('Error:', error);
        });
}


        function replayAudio() {
            // Play the recorded audio again
            playRecordedAudio(document.getElementById('audio_data').value);
        }

        function playRecordedAudio(data) {
            var audioPlayer = document.getElementById('audioPlayer');
            var audioPlayback = document.getElementById('audioPlayback');
            
            // Set the recorded audio data as the source
            var blob = new Blob([data], { type: 'audio/wav' });
            var audioUrl = URL.createObjectURL(blob);
            audioPlayback.src = audioUrl;

            // Show the audio player and replay button
            audioPlayer.style.display = 'block';
            document.getElementById('replayButton').style.display = 'inline-block';
        }
    </script>
</body>
</html>
